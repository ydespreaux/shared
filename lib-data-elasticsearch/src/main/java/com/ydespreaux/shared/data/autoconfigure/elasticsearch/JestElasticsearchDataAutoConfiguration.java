package com.ydespreaux.shared.data.autoconfigure.elasticsearch;import com.ydespreaux.shared.data.autoconfigure.elasticsearch.settings.TemplateAction;import com.ydespreaux.shared.data.autoconfigure.elasticsearch.settings.TemplateProperties;import com.ydespreaux.shared.data.elasticsearch.ElasticsearchOperations;import com.ydespreaux.shared.data.elasticsearch.JestElasticsearchTemplate;import com.ydespreaux.shared.data.elasticsearch.mapping.ElasticsearchConverter;import com.ydespreaux.shared.data.elasticsearch.mapping.MappingElasticsearchConverter;import io.searchbox.client.JestClient;import lombok.*;import lombok.extern.slf4j.Slf4j;import org.apache.commons.io.FilenameUtils;import org.springframework.boot.autoconfigure.AutoConfigureAfter;import org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;import org.springframework.boot.context.properties.EnableConfigurationProperties;import org.springframework.context.ApplicationContext;import org.springframework.context.ApplicationContextAware;import org.springframework.context.annotation.Bean;import org.springframework.context.annotation.Configuration;import org.springframework.core.io.Resource;import org.springframework.util.StringUtils;import java.util.ArrayList;import java.util.List;/** * Configuration providing beans for ElasticSearch operation. * Autoconfigure the use of lib-core-elasctic-jest module. */@Slf4j@Configuration@AutoConfigureAfter(JestElasticsearchAutoConfiguration.class)@EnableConfigurationProperties({TemplateProperties.class})public class JestElasticsearchDataAutoConfiguration implements ApplicationContextAware {    private final TemplateProperties settings;    private ApplicationContext context;    /**     * JestElasticsearchDataAutoConfiguration contructor with the given     * @param settings     */    public JestElasticsearchDataAutoConfiguration(final TemplateProperties settings) {        this.settings = settings;    }    @Bean    @ConditionalOnMissingBean    public ElasticsearchOperations elasticsearchTemplate(final JestClient client) {        JestElasticsearchTemplate operations = new JestElasticsearchTemplate(client, elasticsearchConverter());        buildTemplates().forEach(template -> {            if (template.getAction() != TemplateAction.NONE) {                operations.createTemplate(template.getName(), template.getLocations(), template.getAction() == TemplateAction.CREATE_ONLY);            }        });        return operations;    }    @Bean    @ConditionalOnMissingBean    public ElasticsearchConverter elasticsearchConverter() {        return new MappingElasticsearchConverter(this.context.getEnvironment());    }    @Override    public void setApplicationContext(ApplicationContext applicationContext) {        this.context = applicationContext;    }    /**     * @return     */    protected List<TemplateSettings> buildTemplates() {        final List<TemplateSettings> templates = new ArrayList<>();        if (this.settings.getAction() == TemplateAction.NONE) {            return templates;        }        final String[] profiles = context.getEnvironment().getActiveProfiles();        this.settings.getScripts().forEach(location -> {            List<Resource> locations = new ArrayList<>(profiles.length + 1);            Resource resource = context.getResource(location);            if (resource.exists()) {                locations.add(resource);            } else if (log.isWarnEnabled()) {                log.warn("Resource {} not found", location);            }            String extension = FilenameUtils.getExtension(location);            boolean hasExtension = StringUtils.hasLength(extension);            String prefix = location.substring(0, location.length() - (hasExtension ? extension.length() + 1 : 0));            for (String profile : profiles) {                String profilPath = prefix + "-" + profile + (hasExtension ? "." + extension : "");                Resource profilResource = context.getResource(profilPath);                if (profilResource.exists()) {                    locations.add(profilResource);                }            }            StringBuilder templateName = new StringBuilder(FilenameUtils.getBaseName(resource.getFilename()));            if (profiles.length > 0) {                templateName.append("-").append(profiles[0]);            }            templates.add(TemplateSettings.builder()                    .action(this.settings.getAction())                    .name(templateName.toString())                    .locations(locations)                    .build());        });        return templates;    }    @Getter    @Setter    @NoArgsConstructor    @AllArgsConstructor    @Builder    public static class TemplateSettings {        /**         * Définit le nom du template         */        private String name;        /**         * Définit l'action à effectuer sur le template courant.         */        private TemplateAction action;        /**         * Définit la liste des ressources des scripts du template         */        private List<Resource> locations;    }}